{"version":3,"sources":["../../../src/api/scraper/Scraper.js"],"names":["request","require","fs","cheerio","rp","Scraper","url","imagePath","mkdirSyncRecursive","rpOptions","uri","simple","transform","body","load","Promise","resolve","reject","getTotalPages","then","output","totalPages","getPagesExercises","getPhotos","catch","err","statusCode","$","pages","Number","not","last","text","pagePromises","i","push","getExercisesForPage","all","exercisesUrls","values","reduce","a","b","concat","scrapeExercises","pageNum","pageExercisesUrls","each","find","attr","exerciseUrls","exercisePromises","length","scrapeExercise","exerciseObjects","exerciseUrl","grabExerciseData","exerciseObject","title","getExerciseTitle","slug","slugify","description","getExerciseDescription","taxonomies","getExerciseTaxonomies","steps","getExerciseSteps","images","getExerciseImages","children","first","index","element","splitFields","replace","split","Array","isArray","imageUrls","eq","filename","photos","flatPhotosArray","z","downloadPhotos","readFile","callback","file","shift","head","res","console","log","headers","pipe","createWriteStream","on","directory","path","segment","slice","join","existsSync","mkdirSync","toString","toLowerCase"],"mappings":"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","file":"Scraper.js","sourcesContent":["const request = require('request');\nconst fs = require('fs');\nconst cheerio = require('cheerio');\nconst rp = require('request-promise');\n\nexport class Scraper {\n\n    constructor() {\n        this.url = 'http://db.everkinetic.com';\n        this.imagePath = './assets/exercises/images/';\n        this.mkdirSyncRecursive(this.imagePath);\n\n        this.rpOptions = {\n            uri: this.url,\n            simple: true,\n            transform: function (body) {\n                return cheerio.load(body);\n            }\n        };\n    }\n\n    crawl() {\n\n        return new Promise((resolve, reject) => {\n\n            this.getTotalPages().then((output) => {\n\n                // let totalPages = output.pages;\n                let totalPages = 1; //debug\n\n                this.getPagesExercises(totalPages)\n                    .then((output) => {\n                        resolve(output);\n                        this.getPhotos(output);\n                    })\n                    .catch((err) => {\n                        reject(err.statusCode);\n                    })\n            });\n\n        });\n\n    }\n\n    getTotalPages() {\n        return new Promise((resolve, reject) => {\n            rp(this.rpOptions)\n                .then(($) => {\n                    resolve({\n                        pages: Number($('.page-numbers').not('.next').last().text())\n                    });\n                })\n                .catch((err) => {\n                    reject(err.statusCode);\n                })\n        });\n    }\n\n    getPagesExercises(pages) {\n\n        let pagePromises = [];\n        for (let i = 1; i <= pages; i++) {\n            pagePromises.push(this.getExercisesForPage(i))\n        }\n\n        return Promise.all(pagePromises).then(values => {\n            const exercisesUrls = values.reduce((a, b) => a.concat(b), []);\n            return this.scrapeExercises(exercisesUrls);\n        });\n    }\n\n    getExercisesForPage(pageNum) {\n\n        this.rpOptions.uri = `${this.url}/page/${pageNum}`;\n\n        return new Promise((resolve, reject) => {\n            rp(this.rpOptions)\n                .then(($) => {\n                    let pageExercisesUrls = [];\n                    $('article').each(function (i) {\n                        pageExercisesUrls[i] = $(this).find('h3').find('a').attr('href');\n                    });\n                    resolve(pageExercisesUrls);\n                })\n                .catch(function (err) {\n                    reject(err);\n                });\n        });\n\n    }\n\n    scrapeExercises(exerciseUrls) {\n        let exercisePromises = [];\n\n        for (let i = 0; i < exerciseUrls.length; i++) {\n            exercisePromises.push(this.scrapeExercise(exerciseUrls[i]));\n        }\n\n        return Promise.all(exercisePromises).then(exerciseObjects => {\n            return exerciseObjects;\n        });\n\n    }\n\n    scrapeExercise(exerciseUrl) {\n        return new Promise((resolve, reject) => {\n            rp({\n                uri: exerciseUrl,\n                transform: function (body) {\n                    return cheerio.load(body);\n                }\n            })\n                .then(($) => {\n                    resolve(this.grabExerciseData($));\n                })\n                .catch(function (err) {\n                    reject(err);\n                });\n        });\n    }\n\n    grabExerciseData($) {\n        const exerciseObject = {};\n\n        exerciseObject.title = this.getExerciseTitle($);\n        exerciseObject.slug = this.slugify(exerciseObject.title);\n        exerciseObject.description = this.getExerciseDescription($);\n        exerciseObject.taxonomies = this.getExerciseTaxonomies($);\n        exerciseObject.steps = this.getExerciseSteps($);\n        exerciseObject.images = this.getExerciseImages($, exerciseObject);\n\n        return exerciseObject;\n    }\n\n    getExerciseTitle($) {\n        return $('.entry-title').find('a').text();\n    }\n\n    getExerciseDescription($) {\n        return $('.exercise-entry-content').children().first().text();\n    }\n\n    getExerciseTaxonomies($) {\n        const taxonomies = {};\n\n        $('.exercise-taxonomies').find('a').each((index, element) => {\n            const splitFields = $(element).attr('href').replace(`${this.url}/`, '').split('/');\n\n            if (splitFields[0] === 'equipment') {\n                if (Array.isArray(taxonomies[splitFields[0]])) {\n                    taxonomies[splitFields[0]].push(splitFields[1]);\n                } else {\n                    taxonomies[splitFields[0]] = [splitFields[1]];\n                }\n\n            } else {\n                taxonomies[splitFields[0]] = splitFields[1];\n            }\n\n        });\n\n        return taxonomies;\n    }\n\n    getExerciseSteps($) {\n\n        let steps = [];\n\n        $('.exercise-entry-content').find('ol').children().each((index, element) => {\n            steps.push($(element).text())\n        });\n\n        return steps;\n    }\n\n    getExerciseImages($, exerciseObject) {\n\n        let imageUrls = [];\n\n        $('.download-exercise-images').children().eq(1).find('a').each((index, element) => {\n\n            imageUrls.push({\n                url: $(element).attr('href'),\n                filename: `${this.imagePath}${exerciseObject.slug}-${index}.png`\n            });\n\n        });\n\n        return imageUrls;\n    }\n\n    getPhotos(photos) {\n\n        let flatPhotosArray = [];\n\n        for (let i = 0; i < photos.length; i++) {\n            for (let z = 0; z < photos[i].images.length; z++) {\n                flatPhotosArray.push(photos[i].images[z]);\n            }\n        }\n\n        this.downloadPhotos(flatPhotosArray);\n    }\n\n    downloadPhotos(flatPhotosArray) {\n\n        let readFile = function (callback) {\n            if (flatPhotosArray.length > 0) {\n                let file = flatPhotosArray.shift(),\n                    uri = file.url,\n                    filename = file.filename;\n\n                request.head(uri, function (err, res, body) {\n\n                    if (err || !res) {\n                        console.log('no res', err);\n                        return;\n                    }\n\n                    if (res.headers['content-length'] === 0 || res.headers['content-type'] !== 'image/png') {\n                        console.log('no data for image', filename);\n                        return;\n                    }\n\n                    request(uri).pipe(fs.createWriteStream(filename)).on('close', () => {\n                        console.log('downloaded ' + filename);\n                        readFile(callback);\n                    });\n\n                });\n\n            } else {\n                callback();\n            }\n        };\n\n        readFile(function () {\n            console.log('reading finishes');\n        });\n    }\n\n    mkdirSyncRecursive(directory) {\n        let path = directory.replace(/\\/$/, '').split('/');\n\n        for (let i = 1; i <= path.length; i++) {\n            let segment = path.slice(0, i).join('/');\n            !fs.existsSync(segment) ? fs.mkdirSync(segment) : null;\n        }\n    }\n\n    slugify(text) {\n        return text.toString().toLowerCase()\n            .replace(/\\s+/g, '-')           // Replace spaces with -\n            .replace(/[^\\w\\-]+/g, '')       // Remove all non-word chars\n            .replace(/\\-\\-+/g, '-')         // Replace multiple - with single -\n            .replace(/^-+/, '')             // Trim - from start of text\n            .replace(/-+$/, '');            // Trim - from end of text\n    }\n}\n"]}